{% schema %}
{
  "name": "Collection Page",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        { "value": "1", "label": "Light" },
        { "value": "2", "label": "Dark" },
        { "value": "3", "label": "Accent" }
      ],
      "default": "1"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Columns on desktop",
      "default": "4",
      "options": [
        { "value": "3", "label": "3 columns" },
        { "value": "4", "label": "4 columns" },
        { "value": "5", "label": "5 columns" }
      ]
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns on mobile",
      "default": "2",
      "options": [
        { "value": "1", "label": "1 column" },
        { "value": "2", "label": "2 columns" }
      ]
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 12,
      "label": "Products per page"
    },
    {
      "type": "header",
      "content": "Collection Header"
    },
    {
      "type": "text",
      "id": "header_label",
      "label": "Header label",
      "default": "The Collection"
    },
    {
      "type": "checkbox",
      "id": "show_collection_image",
      "label": "Show collection image",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_collection_description",
      "label": "Show collection description",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_product_count",
      "label": "Show product count",
      "default": true
    },
    {
      "type": "header",
      "content": "Filtering & Sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    },
    {
      "type": "select",
      "id": "filter_style",
      "label": "Filter style",
      "default": "drawer",
      "options": [
        { "value": "drawer", "label": "Side drawer" },
        { "value": "inline", "label": "Inline (above products)" }
      ]
    },
    {
      "type": "header",
      "content": "Product Cards"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "label": "Show second image on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_quick_add",
      "label": "Show quick add button",
      "default": false
    },
    {
      "type": "header",
      "content": "Labels"
    },
    {
      "type": "text",
      "id": "sort_label",
      "label": "Sort button text",
      "default": "Sort"
    },
    {
      "type": "text",
      "id": "filter_label",
      "label": "Filter button text",
      "default": "Filter"
    },
    {
      "type": "text",
      "id": "clear_filters_label",
      "label": "Clear filters text",
      "default": "Clear All Filters"
    },
    {
      "type": "text",
      "id": "no_products_text",
      "label": "No products text",
      "default": "No products found"
    },
    {
      "type": "text",
      "id": "previous_label",
      "label": "Previous page text",
      "default": "Previous"
    },
    {
      "type": "text",
      "id": "next_label",
      "label": "Next page text",
      "default": "Next"
    }
  ]
}
{% endschema %}

{% if collection %}
{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign columns_desktop = section.settings.columns_desktop | default: 4
  assign columns_mobile = section.settings.columns_mobile | default: 2
-%}

<div class="color-scheme-{{ section.settings.color_scheme }} pt-24 md:pt-32 pb-16 md:pb-24 px-4 md:px-8 max-w-7xl mx-auto min-h-screen" x-data="{ filterOpen: false }">

  {%- comment -%} COLLECTION IMAGE {%- endcomment -%}
  {%- if section.settings.show_collection_image and collection.image -%}
    <div class="aspect-[21/9] bg-stone-100 overflow-hidden mb-10 md:mb-16">
      {{ collection.image | image_url: width: 2000 | image_tag: class: 'w-full h-full object-cover', loading: 'eager' }}
    </div>
  {%- endif -%}

  {%- comment -%} HEADER {%- endcomment -%}
  <header class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-10 md:mb-16 border-b border-stone-100 pb-6 md:pb-8">
    <div>
      {% if section.settings.header_label != blank %}
        <span class="text-[10px] uppercase tracking-[0.4em] text-stone-400 font-bold block mb-2 md:mb-4">{{ section.settings.header_label }}</span>
      {% endif %}
      <h1 class="text-2xl md:text-4xl lg:text-5xl font-light tracking-tight uppercase">{{ collection.title }}</h1>
      {%- if section.settings.show_collection_description and collection.description != blank -%}
        <p class="text-sm text-stone-500 mt-2 max-w-xl">{{ collection.description | strip_html | truncate: 150 }}</p>
      {%- endif -%}
      {%- if section.settings.show_product_count -%}
        <p class="text-xs text-stone-400 mt-2">{{ collection.products_count }} product{% if collection.products_count != 1 %}s{% endif %}</p>
      {%- endif -%}
    </div>

    <div class="flex gap-4 md:gap-6 items-center">
      {%- comment -%} SORT DROPDOWN {%- endcomment -%}
      {%- if section.settings.enable_sorting -%}
        <div class="relative" x-data="{ open: false }">
          <button
            @click="open = !open"
            @click.away="open = false"
            class="text-[9px] uppercase tracking-widest font-bold flex items-center gap-2 hover:text-stone-600 transition-colors"
            aria-label="{{ section.settings.sort_label }}"
          >
            {{ section.settings.sort_label }}
            <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': open }" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M19 9l-7 7-7-7"/>
            </svg>
          </button>
          <div
            x-show="open"
            x-transition
            class="absolute right-0 mt-2 w-48 bg-white border border-stone-100 shadow-lg z-40"
          >
            {%- for option in collection.sort_options -%}
              <a
                href="{{ collection.url }}?sort_by={{ option.value }}{% if collection.current_vendor %}&q={{ collection.current_vendor }}{% endif %}"
                class="block px-4 py-2 text-xs hover:bg-stone-50 transition-colors {% if option.value == sort_by %}font-bold text-stone-900{% else %}text-stone-600{% endif %}"
              >
                {{ option.name }}
              </a>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}

      {%- comment -%} FILTER BUTTON {%- endcomment -%}
      {%- if section.settings.enable_filtering and collection.filters.size > 0 -%}
        <button
          @click="filterOpen = !filterOpen"
          class="text-[9px] uppercase tracking-widest font-bold flex items-center gap-2 hover:text-stone-600 transition-colors"
          aria-label="{{ section.settings.filter_label }}"
        >
          {{ section.settings.filter_label }}
          {%- assign active_filter_count = 0 -%}
          {%- for filter in collection.filters -%}
            {%- assign active_filter_count = active_filter_count | plus: filter.active_values.size -%}
          {%- endfor -%}
          {%- if active_filter_count > 0 -%}
            <span class="w-5 h-5 bg-stone-900 text-white rounded-full text-[9px] flex items-center justify-center">{{ active_filter_count }}</span>
          {%- endif -%}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M4 6h16M4 12h16M4 18h7"/>
          </svg>
        </button>
      {%- endif -%}
    </div>
  </header>

  <div class="flex gap-8">
    {%- comment -%} FILTER SIDEBAR {%- endcomment -%}
    {%- if section.settings.enable_filtering and collection.filters.size > 0 -%}
      <aside
        class="fixed inset-y-0 left-0 w-80 bg-white z-50 transform transition-transform duration-300 shadow-xl p-8 overflow-y-auto md:relative md:inset-auto md:w-64 md:shadow-none md:p-0 md:transform-none"
        :class="filterOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
      >
        <div class="flex justify-between items-center mb-8 md:hidden">
          <span class="text-sm font-bold uppercase tracking-widest">{{ section.settings.filter_label }}</span>
          <button @click="filterOpen = false" class="text-stone-400 hover:text-stone-900" aria-label="Close filters">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <form id="FacetFiltersForm" class="space-y-8">
          {%- for filter in collection.filters -%}
            <details class="group" {% if filter.active_values.size > 0 %}open{% endif %}>
              <summary class="flex justify-between items-center cursor-pointer list-none text-[10px] uppercase tracking-widest font-bold text-stone-500 hover:text-stone-900 transition-colors py-2">
                {{ filter.label }}
                <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"/></svg>
              </summary>

              <div class="pt-4 space-y-2">
                {%- case filter.type -%}
                  {%- when 'list' -%}
                    {%- for value in filter.values -%}
                      <label class="flex items-center gap-3 cursor-pointer group/item">
                        <input
                          type="checkbox"
                          name="{{ value.param_name }}"
                          value="{{ value.value }}"
                          {% if value.active %}checked{% endif %}
                          {% if value.count == 0 and value.active == false %}disabled{% endif %}
                          class="w-4 h-4 border-stone-300 text-stone-900 focus:ring-stone-500 rounded"
                          onchange="this.form.submit()"
                        >
                        <span class="text-sm text-stone-600 group-hover/item:text-stone-900 transition-colors {% if value.count == 0 and value.active == false %}opacity-40{% endif %}">
                          {{ value.label }} ({{ value.count }})
                        </span>
                      </label>
                    {%- endfor -%}

                  {%- when 'price_range' -%}
                    <div class="flex items-center gap-4">
                      <div class="flex-1">
                        <label class="text-xs text-stone-400 block mb-1">Min</label>
                        <input
                          type="number"
                          name="{{ filter.min_value.param_name }}"
                          value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"
                          placeholder="{{ filter.range_min | money_without_currency }}"
                          min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          class="w-full px-3 py-2 border border-stone-200 text-sm"
                        >
                      </div>
                      <span class="text-stone-300">&mdash;</span>
                      <div class="flex-1">
                        <label class="text-xs text-stone-400 block mb-1">Max</label>
                        <input
                          type="number"
                          name="{{ filter.max_value.param_name }}"
                          value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"
                          placeholder="{{ filter.range_max | money_without_currency }}"
                          min="{{ filter.range_min | money_without_currency | replace: ',', '' }}"
                          max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                          class="w-full px-3 py-2 border border-stone-200 text-sm"
                        >
                      </div>
                    </div>
                    <button type="submit" class="w-full mt-4 py-2 bg-stone-900 text-white text-xs uppercase tracking-widest font-bold hover:bg-stone-800 transition-colors">
                      Apply
                    </button>
                {%- endcase -%}
              </div>
            </details>
          {%- endfor -%}

          {%- assign has_active = false -%}
          {%- for filter in collection.filters -%}
            {%- if filter.active_values.size > 0 or filter.min_value.value or filter.max_value.value -%}
              {%- assign has_active = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if has_active -%}
            <a
              href="{{ collection.url }}?sort_by={{ sort_by }}"
              class="block text-center py-3 text-xs uppercase tracking-widest text-stone-500 hover:text-stone-900 transition-colors border-t border-stone-100 mt-8 pt-4"
            >
              {{ section.settings.clear_filters_label }}
            </a>
          {%- endif -%}
        </form>
      </aside>

      {%- comment -%} Overlay for mobile {%- endcomment -%}
      <div
        class="fixed inset-0 bg-black/30 z-40 md:hidden"
        x-show="filterOpen"
        x-transition:enter="transition-opacity duration-300"
        x-transition:leave="transition-opacity duration-300"
        @click="filterOpen = false"
      ></div>
    {%- endif -%}

    {%- comment -%} PRODUCT GRID {%- endcomment -%}
    <div class="flex-1">
      {%- comment -%} Active Filters Pills {%- endcomment -%}
      {%- assign has_active_filters = false -%}
      {%- for filter in collection.filters -%}
        {%- if filter.active_values.size > 0 -%}
          {%- assign has_active_filters = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if has_active_filters -%}
        <div class="flex flex-wrap gap-2 mb-6">
          {%- for filter in collection.filters -%}
            {%- for value in filter.active_values -%}
              <a
                href="{{ value.url_to_remove }}"
                class="inline-flex items-center gap-2 px-3 py-1 bg-stone-100 text-xs text-stone-600 hover:bg-stone-200 transition-colors"
              >
                {{ value.label }}
                <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
              </a>
            {%- endfor -%}
          {%- endfor -%}
        </div>
      {%- endif -%}

      {% paginate collection.products by section.settings.products_per_page %}
        <div class="grid grid-cols-{{ columns_mobile }} md:grid-cols-{{ columns_desktop }} gap-4 md:gap-8">
          {%- for product in collection.products -%}
            {% render 'product-card', product: product, show_vendor: section.settings.show_vendor %}
          {%- else -%}
            <div class="col-span-full text-center py-16">
              <p class="text-stone-400 text-lg mb-4">{{ section.settings.no_products_text }}</p>
              <a href="{{ collection.url }}" class="text-sm underline text-stone-600 hover:text-stone-900">{{ section.settings.clear_filters_label }}</a>
            </div>
          {%- endfor -%}
        </div>

        {%- comment -%} PAGINATION {%- endcomment -%}
        {%- if paginate.pages > 1 -%}
          <nav class="flex justify-center items-center mt-16 gap-2" aria-label="Pagination">
            {%- if paginate.previous -%}
              <a href="{{ paginate.previous.url }}" class="px-4 py-2 border border-stone-200 text-xs uppercase tracking-widest hover:border-stone-900 transition-colors">
                {{ section.settings.previous_label }}
              </a>
            {%- endif -%}

            {%- for part in paginate.parts -%}
              {%- if part.is_link -%}
                <a href="{{ part.url }}" class="w-10 h-10 flex items-center justify-center text-sm hover:bg-stone-100 transition-colors">
                  {{ part.title }}
                </a>
              {%- else -%}
                {%- if part.title == paginate.current_page -%}
                  <span class="w-10 h-10 flex items-center justify-center text-sm bg-stone-900 text-white">
                    {{ part.title }}
                  </span>
                {%- else -%}
                  <span class="w-10 h-10 flex items-center justify-center text-sm text-stone-300">
                    {{ part.title }}
                  </span>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if paginate.next -%}
              <a href="{{ paginate.next.url }}" class="px-4 py-2 border border-stone-200 text-xs uppercase tracking-widest hover:border-stone-900 transition-colors">
                {{ section.settings.next_label }}
              </a>
            {%- endif -%}
          </nav>
        {%- endif -%}
      {% endpaginate %}
    </div>
  </div>
</div>
{% else %}
<div class="pt-24 md:pt-32 pb-16 md:pb-24 px-4 md:px-8 max-w-7xl mx-auto min-h-screen text-center">
  <h1 class="text-2xl md:text-4xl font-light tracking-tight uppercase mb-4">{{ 'collections.general.not_found' | t | default: 'Collection not found' }}</h1>
  <p class="text-stone-500 mb-8">{{ 'collections.general.not_found_description' | t | default: "The collection you're looking for doesn't exist." }}</p>
  <a href="{{ routes.collections_url }}" class="text-sm underline text-stone-600 hover:text-stone-900">{{ 'collections.general.browse_all' | t | default: 'Browse all collections' }}</a>
</div>
{% endif %}
